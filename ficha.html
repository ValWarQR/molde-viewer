<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha del Molde</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      color: #2b6cb0;
      margin-bottom: 10px;
    }

    .sub {
      text-align: center;
      margin-bottom: 30px;
      font-size: 16px;
      color: #555;
    }

    .table-container {
      overflow-x: auto;
      margin: auto;
      max-width: 1000px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    th, td {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background-color: #f1f5f9;
      font-weight: 600;
      color: #111827;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    .error {
      background-color: #ffe0e0;
      color: #a10000;
      padding: 15px;
      border-left: 6px solid #a10000;
      border-radius: 6px;
      margin: 20px auto;
      max-width: 700px;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 14px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <h1>Ficha del Molde</h1>
  <p class="sub">ID buscado: <strong id="debugId">(cargando)</strong></p>

  <div id="moldeData" class="loading">Cargando datos desde la hoja de cálculo...</div>

  <script>
    const idMolde = new URLSearchParams(window.location.search).get("id")?.trim().toUpperCase();
    document.getElementById("debugId").textContent = idMolde || "(no definido)";
    const outputEl = document.getElementById("moldeData");

    if (!idMolde) {
      outputEl.innerHTML = "<div class='error'>❌ ID no proporcionado en la URL.</div>";
    } else {
      const sheetURL = "https://docs.google.com/spreadsheets/d/1RvO6jCULlX2g1M3UANoD15-XB3eo5UUNt_78wVVUU9o/gviz/tq?tqx=out:json&sheet=QR%20Generator";

      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const headers = json.table.cols.map(col => col.label);
          const rows = json.table.rows.map(r => r.c.map(cell => cell?.v || ""));

          const matches = rows.filter(row => (row[0] || "").toString().trim().toUpperCase() === idMolde);

          if (matches.length === 0) {
            outputEl.innerHTML = "<div class='error'>❌ No se encontraron registros para ese ID.</div>";
            return;
          }

          let html = `<div class="table-container"><table><thead><tr>`;
          headers.forEach(header => {
            html += `<th>${header}</th>`;
          });
          html += `</tr></thead><tbody>`;

          matches.forEach(row => {
            html += `<tr>`;
            row.forEach((cell, index) => {
  const header = headers[index];

  // Detectar si es la columna "Last revision"
  if (header.toLowerCase().includes("last revision")) {
    const date = new Date(cell);
    if (!isNaN(date)) {
      const formatted = date.toLocaleDateString("es-ES", {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      html += `<td>${formatted}</td>`;
    } else {
      html += `<td>${cell}</td>`;
    }
  } else {
    html += `<td>${cell}</td>`;
  }

            });
            html += `</tr>`;
          });

          html += `</tbody></table></div>`;
          outputEl.innerHTML = html;
        })
        .catch(err => {
          console.error("Error al cargar datos:", err);
          outputEl.innerHTML = "<div class='error'>❌ Error al cargar los datos. Intenta nuevamente más tarde.</div>";
        });
    }
  </script>

</body>
</html>
